<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wanzofc Mail</title>
    <style>
        /* ... (CSS dari contoh sebelumnya) ... */
        /* CSS tambahan untuk chat */
        #chatContainer {
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 20px;
            height: 200px;
            overflow-y: auto;
        }
        #chatMessages {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .chatMessage {
            margin-bottom: 5px;
        }
        .userMessage {
            text-align: right;
            color: blue;
        }
        .adminMessage {
            text-align: left;
            color: green;
        }
        #chatInput {
            width: 70%;
            padding: 8px;
            margin-top: 10px;
        }
        #sendButton {
            padding: 8px 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
         #customEmailNotification {
            position: fixed; /* Fixed position */
            bottom: 20px;    /* 20px from the bottom */
            right: 20px;   /* 20px from the right */
            background-color: #4CAF50; /* Green background */
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            display: none; /* Initially hidden */
            z-index: 1000; /* Ensure it's on top */
        }
        #adminStatus {
          position: fixed;
          top: 10px;
          right: 10px;
          padding: 5px 10px;
          border-radius: 3px;
          font-size: 0.9em;
        }

        .admin-online {
            background-color: #d4edda; /* Green */
            color: #155724;
        }

        .admin-offline {
            background-color: #f8d7da; /* Red */
            color: #721c24;
        }

    </style>
</head>
<body>
  <div class="container">
        <h1>Wanzofc Mail</h1>

        <div id="adminStatus" class="admin-offline">Admin Offline</div>

        <div id="emailSection">
            <div id="emailAddress"></div>
            <button id="copyButton" class="hidden">Salin</button>
        </div>

        <div id="timer"></div>

        <div id="customEmailSection">
            <p>Ingin email custom? <button id="openChatButton">Chat dengan Admin</button></p>
        </div>

        <div id="emailList" class="hidden">
            <h2>Inbox</h2>
            <button id="refreshButton">Refresh</button>
            <div id="emails"></div>
        </div>
        <div id="message"></div>


        <!-- Chat (Integrasi dengan Socket.IO) -->
      <div id="chatContainer" class="hidden">
          <h2>Chat</h2>
          <ul id="chatMessages"></ul>
          <input type="text" id="chatInput" placeholder="Ketik pesan...">
          <button id="sendButton">Kirim</button>
      </div>

        <div id="customEmailNotification">Email custom telah dibuat!</div>

    </div>

    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js" integrity="sha384-c79v8a265Nfe5f4kSQ+K6hYfSCj/vhqR6yv+SGOK4+jRro9iGSxFo+uubqlo+b" crossorigin="anonymous"></script>

    <script>
       const emailAddressDiv = document.getElementById('emailAddress');
        const copyButton = document.getElementById('copyButton');
        const timerDiv = document.getElementById('timer');
        const emailsDiv = document.getElementById('emails');
        const emailListDiv = document.getElementById('emailList');
        const messageDiv = document.getElementById('message');
        const refreshButton = document.getElementById('refreshButton');
        const openChatButton = document.getElementById('openChatButton');

        //Chat
        const chatContainer = document.getElementById('chatContainer');
        const chatMessagesList = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const customEmailNotification = document.getElementById('customEmailNotification');
        const adminStatusDiv = document.getElementById('adminStatus');


        let currentEmailAddress = '';
        let emailRefreshInterval;
        let timerInterval;
        let expirationTime;
        let chatId = null;

        const socket = io(); // Inisialisasi Socket.IO client


        //Event listener untuk perubahan status admin.
        socket.on('admin-status-change', ({online}) => {
          adminStatusDiv.textContent = online ? "Admin Online" : "Admin Offline";
          adminStatusDiv.className = online ? 'admin-online' : 'admin-offline';
        });

        //Ketika email custom sudah di buat
        socket.on('custom-email-created', ({email}) => {
          //Tampilkan notifikasi
          customEmailNotification.textContent = `Email custom ${email} telah dibuat untukmu!`;
          customEmailNotification.style.display = "block";

          //Sembunyikan notif setelah 5 detik
          setTimeout(()=>{
            customEmailNotification.style.display = 'none';
          }, 5000);
        });

        socket.on('connect', () => {
          console.log("Connected to server via Socket.IO", socket.id);
          //Setelah koneksi berhasil, kirim email pengguna ke server untuk registrasi.
            if(currentEmailAddress){
              socket.emit('register', currentEmailAddress);
            }
        });


        socket.on('chat-started', (data) => {
          chatId = data.chatId;
          chatContainer.classList.remove('hidden'); // Tampilkan chat
          chatMessagesList.innerHTML = ''; // Kosongkan pesan
        });

        socket.on('chat-message', ({ chatId: serverChatId, message }) => {
            if (serverChatId !== chatId) {
                return; // Abaikan pesan dari chat yang tidak aktif
            }
            const messageItem = document.createElement('li');
            messageItem.classList.add('chatMessage');
            messageItem.classList.add(message.sender === 'user' ? 'userMessage' : 'adminMessage');
            messageItem.textContent = `${message.sender}: ${message.text}`;
            chatMessagesList.appendChild(messageItem);
            chatContainer.scrollTop = chatContainer.scrollHeight; // Scroll ke bawah
        });


        //Error handling untuk chat.
        socket.on('chat-error', ({message}) => {
          messageDiv.textContent = message;
          messageDiv.style.color = 'red';
        });


        async function createNewEmail() {
           try {
                const response = await fetch('/create-email');
                const data = await response.json();

                if (response.ok) {
                    currentEmailAddress = data.email;
                    expirationTime = data.expiresAt;
                    emailAddressDiv.textContent = currentEmailAddress;

                    // Tampilkan tombol, inbox, dll.
                    copyButton.classList.remove('hidden');
                    emailListDiv.classList.remove('hidden');
                    document.getElementById('emailSection').classList.remove('hidden');

                    // Kosongkan inbox dan ambil email
                    emailsDiv.innerHTML = '';
                    fetchEmails();
                    if (emailRefreshInterval) clearInterval(emailRefreshInterval);
                    emailRefreshInterval = setInterval(fetchEmails, 5000);

                    // Update timer
                    updateTimer();
                    if (timerInterval) clearInterval(timerInterval);
                    timerInterval = setInterval(updateTimer, 1000);

                    // Registrasi socket setelah email dibuat
                    socket.emit('register', currentEmailAddress);


                } else {
                    messageDiv.textContent = data.message || 'Gagal membuat email.';
                    messageDiv.style.color = 'red';
                }
            } catch (error) {
                console.error('Error:', error);
                 messageDiv.textContent = 'Terjadi kesalahan.';
                messageDiv.style.color = 'red';
            }
        }

        async function fetchEmails() {
            if (!currentEmailAddress) return;

            try {
                const response = await fetch(`/emails?address=${currentEmailAddress}`);
                const data = await response.json();

                if (response.ok) {
                    emailsDiv.innerHTML = '';
                    if (data.length === 0) {
                        emailsDiv.innerHTML = '<p>Belum ada email masuk.</p>';
                        return;
                    }
                    data.forEach(email => {
                        const emailItem = document.createElement('div');
                        emailItem.classList.add('emailItem');
                        emailItem.innerHTML = `
                            <strong>Dari: ${email.from}</strong>
                            <strong>Subjek: ${email.subject}</strong>
                            <p>${email.body}</p>
                        `;
                        emailsDiv.appendChild(emailItem);
                    });
                } else {
                  messageDiv.textContent = data.message || "Gagal mengambil email";
                  messageDiv.style.color = "red";
                }

            } catch (error) {
              console.error("Error fetching emails", error);
               messageDiv.textContent = "Terjadi kesalahan saat mengambil email.";
              messageDiv.style.color = "red";
            }
        }

        function updateTimer() {
          const now = Date.now();
            const timeLeft = expirationTime - now;

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                timerDiv.textContent = "Email telah kedaluwarsa. Membuat email baru...";
                createNewEmail(); // Buat email baru
                return;
            }

            const hours = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

            timerDiv.textContent = `Email ini akan hangus dalam: ${hours}j ${minutes}m ${seconds}d`;
        }


        copyButton.addEventListener('click', () => {
            navigator.clipboard.writeText(currentEmailAddress)
            .then(() => {
                messageDiv.textContent = "Email berhasil disalin!";
                messageDiv.style.color = 'green';
                setTimeout(() => { messageDiv.textContent = ''; }, 3000);
            })
            .catch(err => {
                messageDiv.textContent = 'Gagal menyalin email.';
                messageDiv.style.color = 'red';
                console.error('Gagal menyalin: ', err);
            });
        });

        refreshButton.addEventListener('click', fetchEmails);

        openChatButton.addEventListener('click', () => {
            // Mulai chat dengan admin
            socket.emit('start-chat', currentEmailAddress);
        });

        sendButton.addEventListener('click', () => {
            const text = chatInput.value.trim();
            if (text && chatId) {
                socket.emit('chat-message', { chatId, text });
                chatInput.value = ''; // Kosongkan input
            }
        });

        // Buat email baru saat halaman dimuat
        createNewEmail();

    </script>
</body>
</html>
